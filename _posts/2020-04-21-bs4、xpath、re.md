---
title: "bs4、xpath、re"
subtitle: "爬虫「02」"
layout: post
author: "echisenyang"
header-style: text
hidden: true
catalog: true
tags:
  - 爬虫
---



## Beautiful Soup库

1. Beautiful Soup库的理解：
    Beautiful Soup库是解析、遍历、维护“标签树”的功能库，对应一个HTML/XML文档的全部内容
2. BeautifulSoup类的基本元素:
    - `Tag 标签，最基本的信息组织单元，分别用<>和</>标明开头和结尾；`
    - `Name 标签的名字，<p>…</p>的名字是'p'，格式：<tag>.name;`
    - `Attributes 标签的属性，字典形式组织，格式：<tag>.attrs;`
    - `NavigableString 标签内非属性字符串，<>…</>中字符串，格式：<tag>.string;`
    - `Comment 标签内字符串的注释部分，一种特殊的Comment类型;`
3. beautifulsoup解析HTML页面
    - Beautiful Soup 是一个HTML/XML 的解析器，主要用于解析和提取 HTML/XML 数据。 
    - **它基于HTML DOM 的，会载入整个文档，解析整个DOM树，因此时间和内存开销都会大很多，所以性能要低于lxml。** 
    - BeautifulSoup 用来解析 HTML 比较简单，API非常人性化，支持CSS选择器、Python标准库中的HTML解析器，也支持 lxml 的 XML解析器。
    - 虽然说BeautifulSoup4 简单容易比较上手，但是**匹配效率还是远远不如正则以及xpath的，一般不推荐使用，推荐正则的使用。**

### 1. 解析 https://python123.io/ws/demo.html

```python
# 导入bs4库
from bs4 import BeautifulSoup
import requests # 抓取页面

r = requests.get('https://python123.io/ws/demo.html') # Demo网址
demo = r.text  # 抓取的数据
demo
>>> '<html><head><title>This is a python demo page</title></head>\r\n<body>\r\n<p class="title"><b>The demo python introduces several python courses.</b></p>\r\n<p class="course">Python is a wonderful general-purpose programming language. You can learn Python from novice to professional by tracking the following courses:\r\n<a href="http://www.icourse163.org/course/BIT-268001" class="py1" id="link1">Basic Python</a> and <a href="http://www.icourse163.org/course/BIT-1001870001" class="py2" id="link2">Advanced Python</a>.</p>\r\n</body></html>'
```

```python
# 解析HTML页面
soup = BeautifulSoup(demo, 'html.parser')  # 抓取的页面数据；bs4的解析器
# 有层次感的输出解析后的HTML页面
print(soup.prettify())
```

```html
<html>
 <head>
  <title>
   This is a python demo page
  </title>
 </head>
 <body>
  <p class="title">
   <b>
    The demo python introduces several python courses.
   </b>
  </p>
  <p class="course">
   Python is a wonderful general-purpose programming language. You can learn Python from novice to professional by tracking the following courses:
   <a class="py1" href="http://www.icourse163.org/course/BIT-268001" id="link1">
    Basic Python
   </a>
   and
   <a class="py2" href="http://www.icourse163.org/course/BIT-1001870001" id="link2">
    Advanced Python
   </a>
   .
  </p>
 </body>
</html>
```

-  `1）标签，用soup.<tag>访问获得:`

  `当HTML文档中存在多个相同<tag>对应内容时，soup.<tag>返回第一个`

```python
soup.a # 访问标签a
>>> <a class="py1" href="http://www.icourse163.org/course/BIT-268001" id="link1">Basic Python</a>

soup.title
>>> <title>This is a python demo page</title>
```

- `2）标签的名字:每个<tag>都有自己的名字，通过soup.<tag>.name获取，字符串类型`

```python
soup.a.name
>>> 'a'

soup.a.parent.name
>>> 'p'

soup.p.parent.name
>>> 'body'
```

-  `3)标签的属性,一个<tag>可以有0或多个属性，字典类型,soup.<tag>.attrs`

```python
tag = soup.a
print(tag.attrs)
>>> {'href': 'http://www.icourse163.org/course/BIT-268001', 'class': ['py1'], 'id': 'link1'}
print(tag.attrs['class'])
>>> ['py1']
print(type(tag.attrs))
>>> <class 'dict'>
```

- `4)Attributes:标签内非属性字符串,格式：soup.<tag>.string, NavigableString可以跨越多个层次`

```python
print(soup.a.string)
>>> Basic Python
print(type(soup.a.string))
>>> <class 'bs4.element.NavigableString'>
```

- `6)  .prettify()为HTML文本<>及其内容增加更加'\n',有层次感的输出`

```python
print(soup.a.prettify())
>>> 
<a class="py1" href="http://www.icourse163.org/course/BIT-268001" id="link1">
 Basic Python
</a>
```

- `7)bs4库将任何HTML输入都变成utf‐8编码`

  Python 3.x默认支持编码是utf‐8,解析无障碍

### 2. bs4遍历方法

![5RzNsO](https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/5RzNsO.jpg)

HTML基本格式:`<>…</>`构成了所属关系，形成了标签的树形结构
- 标签树的下行遍历
    * .contents 子节点的列表，将`<tag>`所有儿子节点存入列表
    * .children 子节点的迭代类型，与.contents类似，用于循环遍历儿子节点
    * .descendants 子孙节点的迭代类型，包含所有子孙节点，用于循环遍历
- 标签树的上行遍
    * .parent 节点的父亲标签
    * .parents 节点先辈标签的迭代类型，用于循环遍历先辈节点
- 标签树的平行遍历
    * .next_sibling 返回按照HTML文本顺序的下一个平行节点标签
    * .previous_sibling 返回按照HTML文本顺序的上一个平行节点标签
    * .next_siblings 迭代类型，返回按照HTML文本顺序的后续所有平行节点标签
    * .previous_siblings 迭代类型，返回按照HTML文本顺序的前续所有平行节点标签

* 详见：https://www.cnblogs.com/mengxiaoleng/p/11585754.html#_label0 

### 3. 基于bs4库的HTML内容的查找方法

- <>.find_all(name, attrs, recursive, string, **kwargs) 

    参数：

    - ∙ name : 对标签名称的检索字符串
    - ∙ attrs: 对标签属性值的检索字符串，可标注属性检索
    - ∙ recursive: 是否对子孙全部检索，默认True
    - ∙ string: <>…</>中字符串区域的检索字符串

        简写：

        - `<tag>`(..) 等价于 `<tag>`.find_all(..)
        - soup(..) 等价于 soup.find_all(..)
- 扩展方法：
    - <>.find() 搜索且只返回一个结果，同.find_all()参数
    - <>.find_parents() 在先辈节点中搜索，返回列表类型，同.find_all()参数
    - <>.find_parent() 在先辈节点中返回一个结果，同.find()参数
    - <>.find_next_siblings() 在后续平行节点中搜索，返回列表类型，同.find_all()参数
    - <>.find_next_sibling() 在后续平行节点中返回一个结果，同.find()参数
    - <>.find_previous_siblings() 在前序平行节点中搜索，返回列表类型，同.find_all()参数
    - <>.find_previous_sibling() 在前序平行节点中返回一个结果，同.find()参数

### 4. 实战：中国大学排名定向爬取

![QLl7WV](https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/QLl7WV.png)

```python
r=requests.get('http://www.zuihaodaxue.cn/zuihaodaxuepaiming2019.html')
r.encoding = "UTF-8"
demo=r.text
soup=BeautifulSoup(demo,'html.parser')
```

- 页面解析乱码 -》在窗口console标签下，键入 "document.charset" 即可查看网页的编码方式-〉"UTF-8"

```python
# 爬取table标题
soup.find_all('th')[:4]
>>> 
[<th style="text-align: center;">排名</th>,
 <th style="text-align: center;">学校名称</th>,
 <th class="hidden-xs" style="text-align: center; width: 80px;">省市</th>,
 <th style="text-align: center;">总分</th>]

thead_res.append(soup.find_all('th')[0].string)
thead_res.append(soup.find_all('th')[1].string)
thead_res.append(soup.find_all('th')[3].string)
thead_res
>>> ['排名', '学校名称', '总分']
```

```python
# 爬取table内容
tmp_list=[]
for i in soup.select('tr[class="alt"]'):
    content = i.contents[0:3]
    tmp_list.append([w.string for w in content])

import numpy as np
res["排名"]= list(np.array(tmp_list)[:,0])
res["学校名称"]=list(np.array(tmp_list)[:,1])
res["总分"]=list(np.array(tmp_list)[:,2])
import pandas as pd
res_df= pd.DataFrame(res)
```

<img src="https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/cth2Py.png" alt="cth2Py" style="zoom: 50%;" />

## xpath

1. 学习xpath，使用lxml+xpath提取内容。
2. 使用xpath提取丁香园论坛的回复内容。
3. 抓取丁香园网页：[http://www.dxy.cn/bbs/thread/626626#626626](http://www.dxy.cn/bbs/thread/626626#626626) 。

### 1. Xpath常用的路径表达式

- XPath即为XML路径语言（XML Path Language），它是一种用来确定XML文档中某部分位置的语言。
- 在XPath中，有七种类型的节点：元素、属性、文本、命名空间、处理指令、注释以及文档（根）节点。
- XML文档是被作为节点树来对待的。

XPath使用路径表达式在XML文档中选取节点。节点是通过沿着路径选取的。

- 下面列出了最常用的路径表达式：
  - nodename       选取此节点的所有子节点。
  - /           从根节点选取。
  - //	        从匹配选择的当前节点选择文档中的节点，而不考虑它们的位置。
  - .	           选取当前节点。
  - ..	         选取当前节点的父节点。
  - @	           选取属性。
  - /text()        提取标签下面的文本内容
      - 如：
      - /标签名               逐层提取
      - /标签名               提取所有名为<>的标签
      - //标签名[@属性=“属性值”]   提取包含属性为属性值的标签
      - @属性名               代表取某个属性名的属性值

- 详细学习：https://www.cnblogs.com/gaojun/archive/2012/08/11/2633908.html

### 2. 使用lxml解析

- 导入库：from lxml import etree

- lxml将html文本转成xml对象
    - tree = etree.HTML(html)
    
- 用户名称：tree.xpath(’//div[@class=“auth”]/a/text()’)
- 回复内容：tree.xpath(’//td[@class=“postbody”]’) 因为回复内容中有换行等标签，所以需要用string()来获取数据。
    - string()的详细见链接：https://www.cnblogs.com/CYHISTW/p/12312570.html
    
- Xpath中text()，string()，data()的区别如下：
    - text()仅仅返回所指元素的文本内容。
    - string()函数会得到所指元素的所有节点文本内容，这些文本讲会被拼接成一个字符串。
    - data()大多数时候，data()函数和string()函数通用，而且不建议经常使用data()函数，有数据表明，该函数会影响XPath的性能。

### 3. 实战：爬取丁香园-用户名和回复内容

```python
# 导入库
from lxml import etree
import requests

url = "http://www.dxy.cn/bbs/thread/626626#626626"
# 1. 获取url的html
req = requests.get(url)
html = req.text

# 2. lxml解析html
tree = etree.HTML(html) 

# 3. 利用Xpath表达式获取user和content（完成xpath的语句）
user = tree.xpath('//div[@class="auth"]/a/text()')
>>> ['楼医生', 'lion000', 'xghrh', 'keys']
content = tree.xpath('//td[@class="postbody"]')

#  4. 保存爬取的内容
results = []
for i in range(0, len(user)):
    # print(user[i].strip()+":"+content[i].xpath('string(.)').strip())
    # print("*"*80)
    # 因为回复内容中有换行等标签，所以需要用string()来获取数据
    results.append(user[i].strip() + ":  " + content[i].xpath('string(.)').strip())
```

![vBwH5h](https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/vBwH5h.png)

![fPNUaC](https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/fPNUaC.png)

![mbKsZz](https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/mbKsZz.png)

## 正则表达式 re

### 1. 正则表达式语法

- 常用操作符
     - `.` 表示任何单个字符
  - `[ ]` 字符集，对单个字符给出取值范围 ，如`[abc]`表示a、b、c，`[a‐z]`表示a到z单个字符
  - `[^ ]` 非字符集，对单个字符给出排除范围 ，如`[^abc]`表示非a或b或c的单个字符
  - `*` 前一个字符0次或无限次扩展，如abc* 表示 ab、abc、abcc、abccc等 
  - `+` 前一个字符1次或无限次扩展 ，如abc+ 表示 abc、abcc、abccc等 
  - `?` 前一个字符0次或1次扩展 ，如abc? 表示 ab、abc
  - `|` 左右表达式任意一个 ，如abc|def 表示 abc、def
  - `{m}` 扩展前一个字符m次 ，如ab{2}c表示abbc
  - `{m,n}` 扩展前一个字符m至n次（含n） ，如ab{1,2}c表示abc、abbc
  - `^` 匹配字符串开头 ，如^abc表示abc且在一个字符串的开头
  - `$` 匹配字符串结尾 ，如abc$表示abc且在一个字符串的结尾
  - `( )` 分组标记，内部只能使用 | 操作符 ，如(abc)表示abc，(abc|def)表示abc、def
  - `\d` 数字，等价于`[0‐9]`
  - `\w` 单词字符，等价于`[A‐Za‐z0‐9_]`

### 2. 正则表达式re库的使用

re库采用raw string类型表示正则表达式，表示为：r'text'，raw string是不包含对转义符再次转义的字符串;

- re库的主要功能函数

  - re.search() 在一个字符串中搜索匹配正则表达式的第一个位置，返回match对象 

    `re.search(pattern, string, flags=0)`

  - re.match() 从一个字符串的开始位置起匹配正则表达式，返回match对象

      `re.match(pattern, string, flags=0)`
  - re.findall() 搜索字符串，以列表类型返回全部能匹配的子串

      `re.findall(pattern, string, flags=0)`

  - re.split() 将一个字符串按照正则表达式匹配结果进行分割，返回列表类型

      `re.split(pattern, string, maxsplit=0, flags=0)`

  - re.finditer() 搜索字符串，返回一个匹配结果的迭代类型，每个迭代元素是match对象

      `re.finditer(pattern, string, flags=0)`

  - re.sub() 在一个字符串中替换所有匹配正则表达式的子串，返回替换后的字符串

      `re.sub(pattern, repl, string, count=0, flags=0)`

      flags : 正则表达式使用时的控制标记：
      - re.I -->  re.IGNORECASE :  忽略正则表达式的大小写，`[A‐Z]`能够匹配小写字符
      - re.M -->  re.MULTILINE :  正则表达式中的^操作符能够将给定字符串的每行当作匹配开始
      - re.S -->  re.DOTALL   :  正则表达式中的.操作符能够匹配所有字符，默认匹配除换行外的所有字符

-  re库的另一种等价用法（编译）

  regex = re.compile(pattern, flags=0)：将正则表达式的字符串形式编译成正则表达式对象

-  re 库的贪婪匹配和最小匹配

  - `.*` Re库默认采用贪婪匹配，即输出匹配最长的子串
  - `*?` 只要长度输出可能不同的，都可以通过在操作符后增加?变成最小匹配

