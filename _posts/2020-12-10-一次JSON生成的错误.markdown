---
layout:     post
title:      "一次JSON生成错误的总结"
subtitle:   ""
date:       2020-12-10 10:21:00
author:     "lvjb"
header-img: "img/json-exception/json-exception.png"
catalog: true
tags:
    - JSON
    - 正则表达式
    - 编程
---

#### 问题
公司有部分代码是将一个 JSONObject 对象使用 FreeMarker 转换后生成 JSON ，但使用 new JSONTokener()
构造时，报下列错误：
<img src="/img/json-exception/json-exception.png" style="height:400px">

#### 分析
  一般控制台打印 ``` Expected a ',' or '}'``` 错误的可考虑字符串格式不合法的问题。根据对字符串的分析，确定是某
  value 值中含有双引号导致了生成 JSON 对象失败。故使用正则表达式，将所有在值中出现的双引号替换为单引号解决。
  
  观察一个非格式化的'json'如下：
  ```
  {
    "expDate":"2050-01-0100:00:00",
    "offerDesc":"澳珠通帶機計劃月費$336/1200分鐘(澳珠)10GB(兩地)額外通話收費$019/分鐘額外數據按"兩地循環數據計劃"收取每次$50/5GB當單次用量低於200MB時則按每$25/MB收取。(不適用於先通知後購買服務)",
    "regionName":"澳门(市级)",
    "statusCd":"1000"
  }
  ```
  解决该问题就要将 offerDesc 对应的值中的 "兩地循環數據計劃" 该句双引号替换，即排除 "{"之后，"}"之前，":"之后和之前，","之后和之前的双引号。
  整理出正则表达式如下：
  ```
  "\"(?!((?<=,")|(?<=:")|(?<=\{")|(?=,")|(?=:")|(?=,})))"
```

#### 总结
   - 标准化JSON对象
      <br>标准的 JSON 格式对象中，键值中不应出现转义字符，特殊符号应在字符前加\，避免解析失败等。所以这个问题本应由前台解决，在传入后台时就将
      数据格式化为标准数据，而非在后台取数据时进行转义处理。（这样有可能造成注入安全问题）
   - 正则表达式
      <br> ?<=xxx 表示捕获以 xxx 开头的字符串
      <br> ?=xxx 表示捕获以 xxx 结尾的字符串
            
  

