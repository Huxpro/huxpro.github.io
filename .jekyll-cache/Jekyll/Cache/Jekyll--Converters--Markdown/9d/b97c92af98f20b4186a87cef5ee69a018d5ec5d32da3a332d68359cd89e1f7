I"<blockquote>
  <p>The <code class="highlighter-rouge">has_type</code> relation is good but doesnâ€™t give us a <em>executable algorithm</em> â€“ ä¸æ˜¯ä¸€ä¸ªç®—æ³•
but itâ€™s <em>syntax directed</em>, just one typing rule for one term (unique typing) â€“ translate into function!</p>
</blockquote>

<h2 id="comparing-types">Comparing Types</h2>

<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ check equality for types.
è¿™é‡Œéå¸¸ç®€å•ï¼Œå¦‚æœæ˜¯ SystemF ä¼šéº»çƒ¦å¾ˆå¤šï¼Œå¯¹ <code class="highlighter-rouge">âˆ€</code> è¦åš local nameless æˆ–è€… alpha renaming:</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">Fixpoint</span><span class="w"> </span><span class="no">eqb_ty</span><span class="w"> </span><span class="o">(</span><span class="no">T1</span><span class="w"> </span><span class="no">T2</span><span class="p">:</span><span class="no">ty</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="kr">match</span><span class="w"> </span><span class="no">T1</span><span class="o">,</span><span class="no">T2</span><span class="w"> </span><span class="kp">with</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">Bool</span><span class="o">,</span><span class="w"> </span><span class="no">Bool</span><span class="w"> </span><span class="p">â‡’</span><span class="w">
      </span><span class="no">true</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">Arrow</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">T12</span><span class="o">,</span><span class="w"> </span><span class="no">Arrow</span><span class="w"> </span><span class="no">T21</span><span class="w"> </span><span class="no">T22</span><span class="w"> </span><span class="p">â‡’</span><span class="w">
      </span><span class="no">andb</span><span class="w"> </span><span class="o">(</span><span class="no">eqb_ty</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">T21</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">eqb_ty</span><span class="w"> </span><span class="no">T12</span><span class="w"> </span><span class="no">T22</span><span class="o">)</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="p">_</span><span class="w"> </span><span class="p">â‡’</span><span class="w">
      </span><span class="no">false</span><span class="w">
  </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>ç„¶åæˆ‘ä»¬éœ€è¦ä¸€ä¸ª refl å’Œä¸€ä¸ª reflectionï¼Œå‡†ç¡®å¾—è¯´ï¼šã€Œdefine equality by computationã€ï¼Œåæ–¹å‘ç”¨ refl å³å¯æ˜“è¯</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">Lemma</span><span class="w"> </span><span class="no">eqb_ty_refl</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">T1</span><span class="o">,</span><span class="w">
  </span><span class="no">eqb_ty</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="pi">.</span><span class="w">

</span><span class="k">Lemma</span><span class="w"> </span><span class="no">eqb_ty__eq</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">T1</span><span class="w"> </span><span class="no">T2</span><span class="o">,</span><span class="w">
  </span><span class="no">eqb_ty</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="no">T2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">T2</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="the-typechecker">The Typechecker</h2>

<p>ç›´æ¥ syntax directedï¼Œä¸è¿‡éº»çƒ¦çš„æ˜¯éœ€è¦ pattern matching <code class="highlighter-rouge">option</code>â€¦</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">Fixpoint</span><span class="w"> </span><span class="no">type_check</span><span class="w"> </span><span class="o">(</span><span class="no">Gamma</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">context</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">tm</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">ty</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
      </span><span class="no">Gamma</span><span class="w"> </span><span class="no">x</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">abs</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">t12</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
      </span><span class="kr">match</span><span class="w"> </span><span class="no">type_check</span><span class="w"> </span><span class="o">(</span><span class="no">update</span><span class="w"> </span><span class="no">Gamma</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">T11</span><span class="o">)</span><span class="w"> </span><span class="no">t12</span><span class="w"> </span><span class="kp">with</span><span class="w">     </span><span class="c">(** &lt;-- å¯¹åº” t12 çš„ rule **)</span><span class="w">
      </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">T12</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">Arrow</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">T12</span><span class="o">)</span><span class="w">                 
      </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
      </span><span class="kr">end</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">app</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
      </span><span class="kr">match</span><span class="w"> </span><span class="no">type_check</span><span class="w"> </span><span class="no">Gamma</span><span class="w"> </span><span class="no">t1</span><span class="o">,</span><span class="w"> </span><span class="no">type_check</span><span class="w"> </span><span class="no">Gamma</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="kp">with</span><span class="w">
      </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">Arrow</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">T12</span><span class="o">),</span><span class="no">Some</span><span class="w"> </span><span class="no">T2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
          </span><span class="kr">if</span><span class="w"> </span><span class="no">eqb_ty</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">T2</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">T12</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">None</span><span class="w">       </span><span class="c">(** eqb_ty è§ä¸‹æ–‡ **)</span><span class="w">
      </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
      </span><span class="kr">end</span><span class="w">
  </span><span class="o">...</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨è¯¾å ‚æ—¶æåˆ°å…³äº <code class="highlighter-rouge">eqb_ty</code> çš„ä¸€ä¸ªç»†èŠ‚ï¼ˆæˆ‘ä»¥å‰ä¹Ÿç»å¸¸çŠ¯ï¼Œåœ¨ ML/Haskell ä¸­â€¦â€¦ï¼‰ï¼š
æˆ‘ä»¬èƒ½ä¸èƒ½åœ¨ pattern matching é‡Œæ”¯æŒã€Œç”¨åŒä¸€ä¸ª binding æ¥ imply è¯´ä»–ä»¬ä¸¤éœ€è¦ be equalã€ï¼Ÿ</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c">(** instead of this **)</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">Arrow</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">T12</span><span class="o">),</span><span class="no">Some</span><span class="w"> </span><span class="no">T2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="no">eqb_ty</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">T2</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="o">...</span><span class="w">

</span><span class="c">(** can we do this? **)</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">Arrow</span><span class="w"> </span><span class="no">T</span><span class="w">   </span><span class="no">T'</span><span class="w"> </span><span class="o">),</span><span class="no">Some</span><span class="w"> </span><span class="no">T</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">...</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>the answer is <strong>NO</strong> because this demands a <em>decidable equality</em>. 
æˆ‘å¥½å¥‡çš„æ˜¯ï¼Œç”¨ typeclass æ˜¯ä¸æ˜¯å°±å¯ä»¥ bake in è¿™ä¸ªåŠŸèƒ½äº†ï¼Ÿå°¤å…¶æ˜¯åœ¨ Coq function è¿˜æ˜¯ total çš„æƒ…å†µä¸‹</p>
</blockquote>

<h2 id="digression-improving-the-notation">Digression: Improving the Notation</h2>

<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å®šä¹‰ä¸€ä¸ª Haskell <code class="highlighter-rouge">do</code> notation é£æ ¼çš„ <em>monadic</em> notation:</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">Notation</span><span class="w"> </span><span class="s2">" x &lt;- e1 ;; e2"</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="kr">match</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="kp">with</span><span class="w">
                              </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">â‡’</span><span class="w"> </span><span class="no">e2</span><span class="w">
                              </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="p">â‡’</span><span class="w"> </span><span class="no">None</span><span class="w">
                              </span><span class="kr">end</span><span class="o">)</span><span class="w">
         </span><span class="o">(</span><span class="no">right</span><span class="w"> </span><span class="no">associativity</span><span class="o">,</span><span class="w"> </span><span class="kp">at</span><span class="w"> </span><span class="no">level</span><span class="w"> </span><span class="mi">60</span><span class="o">).</span><span class="w">

</span><span class="k">Notation</span><span class="w"> </span><span class="s2">" 'return' e "</span><span class="w">
  </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">Some</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kp">at</span><span class="w"> </span><span class="no">level</span><span class="w"> </span><span class="mi">60</span><span class="o">).</span><span class="w">

</span><span class="k">Notation</span><span class="w"> </span><span class="s2">" 'fail' "</span><span class="w">
  </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">None</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>å¥½çœ‹ä¸€äº›å§åæ­£ï¼š</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">Fixpoint</span><span class="w"> </span><span class="no">type_check</span><span class="w"> </span><span class="o">(</span><span class="no">Gamma</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">context</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">tm</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">ty</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">â‡’</span><span class="w">
      </span><span class="no">Gamma</span><span class="w"> </span><span class="no">x</span><span class="w"> 
  </span><span class="o">|</span><span class="w"> </span><span class="no">abs</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">t12</span><span class="w"> </span><span class="p">â‡’</span><span class="w">
      </span><span class="no">T12</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">type_check</span><span class="w"> </span><span class="o">(</span><span class="no">update</span><span class="w"> </span><span class="no">Gamma</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">T11</span><span class="o">)</span><span class="w"> </span><span class="no">t12</span><span class="w"> </span><span class="p">;;</span><span class="w">
      </span><span class="kr">return</span><span class="w"> </span><span class="o">(</span><span class="no">Arrow</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">T12</span><span class="o">)</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">app</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="p">â‡’</span><span class="w">
      </span><span class="no">T1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">type_check</span><span class="w"> </span><span class="no">Gamma</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="p">;;</span><span class="w">
      </span><span class="no">T2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">type_check</span><span class="w"> </span><span class="no">Gamma</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="p">;;</span><span class="w">
      </span><span class="kr">match</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="kp">with</span><span class="w"> 
      </span><span class="o">|</span><span class="w"> </span><span class="no">Arrow</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">T12</span><span class="w"> </span><span class="p">â‡’</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="no">eqb_ty</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">T2</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="no">T12</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">fail</span><span class="w">
      </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">â‡’</span><span class="w"> </span><span class="no">fail</span><span class="w">
      </span><span class="kr">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="properties">Properties</h2>

<p>æœ€åæˆ‘ä»¬éœ€è¦éªŒè¯ä¸€ä¸‹ç®—æ³•çš„æ­£ç¡®æ€§ï¼š
è¿™é‡Œçš„ soundness å’Œ completess éƒ½æ˜¯å›´ç»• â€œtypechecking function ~ typing relation inference ruleâ€ è¿™ç»„å…³ç³»æ¥è¯´çš„ï¼š</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">Theorem</span><span class="w"> </span><span class="no">type_checking_sound</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">Gamma</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">T</span><span class="o">,</span><span class="w">
  </span><span class="no">type_check</span><span class="w"> </span><span class="no">Gamma</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">has_type</span><span class="w"> </span><span class="no">Gamma</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">T</span><span class="pi">.</span><span class="w">

</span><span class="k">Theorem</span><span class="w"> </span><span class="no">type_checking_complete</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">âˆ€</span><span class="no">Gamma</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">T</span><span class="o">,</span><span class="w">
  </span><span class="no">has_type</span><span class="w"> </span><span class="no">Gamma</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="p">â†’</span><span class="w"> </span><span class="no">type_check</span><span class="w"> </span><span class="no">Gamma</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">T</span><span class="pi">.</span><span class="w">

</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="exercise">Exercise</h2>

<p>ç»™ <code class="highlighter-rouge">MoreStlc.v</code> é‡Œçš„ StlcE å†™ typechecker, ç„¶å prove soundness / completeness ï¼ˆè¿‡ç¨‹ä¸­ç”¨äº†éå¸¸ mega çš„ tacticsï¼‰</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c">(** è¿˜ä¸èƒ½è¿™ä¹ˆå†™ **)</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">fst</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
    </span><span class="o">(</span><span class="no">Prod</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="no">T2</span><span class="o">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">type_check</span><span class="w"> </span><span class="no">Gamma</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="p">;;</span><span class="w">


</span><span class="c">(** è¦è¿™æ ·â€¦â€¦æ„Ÿè§‰æ˜¯ notation çš„ç¼˜æ•…ï¼Ÿå¹¶ä¸”è¦æä¾› fallback case æ‰èƒ½é€šè¿‡ exhaustive check æ˜¯çœŸçš„ **)</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">fst</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
    </span><span class="no">Tp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">type_check</span><span class="w"> </span><span class="no">Gamma</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="p">;;</span><span class="w">
    </span><span class="kr">match</span><span class="w"> </span><span class="no">Tp</span><span class="w"> </span><span class="kp">with</span><span class="w">
    </span><span class="o">|</span><span class="w"> </span><span class="o">(</span><span class="no">Prod</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="no">T2</span><span class="o">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">T1</span><span class="w">
    </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">fail</span><span class="w">
    </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="extra-exercise-profmtf">Extra Exercise (Prof.Mtf)</h2>

<blockquote>
  <p>I believe this part of exercise was added by Prof. Fluet (not found in SF website version)</p>
</blockquote>

<p>ç»™ <code class="highlighter-rouge">MoreStlc.v</code> çš„ operational semantics å†™ Interpreter (<code class="highlighter-rouge">stepf</code>), ç„¶å prove soundness / completenessâ€¦</p>

<h3 id="step-vs-stepf"><code class="highlighter-rouge">step</code> vs. <code class="highlighter-rouge">stepf</code></h3>

<p>é¦–å…ˆæˆ‘ä»¬å®šä¹‰äº† <code class="highlighter-rouge">value</code> å…³ç³»çš„å‡½æ•°ç‰ˆæœ¬ <code class="highlighter-rouge">valuef</code>ï¼Œ
ç„¶åæˆ‘ä»¬å®šä¹‰ <code class="highlighter-rouge">step</code> å…³ç³»çš„å‡½æ•°ç‰ˆæœ¬ <code class="highlighter-rouge">stepf</code>:</p>

<p>ä»¥ pure STLC ä¸ºä¾‹ï¼š</p>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">Inductive</span><span class="w"> </span><span class="no">step</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">tm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">tm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">ST_AppAbs</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">t12</span><span class="w"> </span><span class="no">v2</span><span class="o">,</span><span class="w">
         </span><span class="no">value</span><span class="w"> </span><span class="no">v2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
         </span><span class="o">(</span><span class="no">app</span><span class="w"> </span><span class="o">(</span><span class="no">abs</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">T11</span><span class="w"> </span><span class="no">t12</span><span class="o">)</span><span class="w"> </span><span class="no">v2</span><span class="o">)</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="o">[</span><span class="no">x</span><span class="p">:</span><span class="o">=</span><span class="no">v2</span><span class="o">]</span><span class="no">t12</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">ST_App1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">t1'</span><span class="w"> </span><span class="no">t2</span><span class="o">,</span><span class="w">
         </span><span class="no">t1</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="no">t1'</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
         </span><span class="o">(</span><span class="no">app</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">t2</span><span class="o">)</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">app</span><span class="w"> </span><span class="no">t1'</span><span class="w"> </span><span class="no">t2</span><span class="o">)</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">ST_App2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="no">t2'</span><span class="o">,</span><span class="w">
         </span><span class="no">value</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
         </span><span class="no">t2</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="no">t2'</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
         </span><span class="o">(</span><span class="no">app</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">t2</span><span class="o">)</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">app</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">t2'</span><span class="o">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">Fixpoint</span><span class="w"> </span><span class="no">stepf</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">tm</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">tm</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
  </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">x</span><span class="w">        </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="c">(* We only define step for closed terms *)</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">abs</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="c">(* Abstraction is a value *)</span><span class="w">
  </span><span class="o">|</span><span class="w"> </span><span class="no">app</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">t2</span><span class="w">    </span><span class="o">=&gt;</span><span class="w">
    </span><span class="kr">match</span><span class="w"> </span><span class="no">stepf</span><span class="w"> </span><span class="no">t1</span><span class="o">,</span><span class="w"> </span><span class="no">stepf</span><span class="w"> </span><span class="no">t2</span><span class="o">,</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="kp">with</span><span class="w">
    </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">t1'</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">       </span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">           </span><span class="o">=&gt;</span><span class="w">                     </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">app</span><span class="w"> </span><span class="no">t1'</span><span class="w"> </span><span class="no">t2</span><span class="o">)</span><span class="w">
    </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w">    </span><span class="o">,</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">t2'</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">           </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">assert</span><span class="w"> </span><span class="o">(</span><span class="no">valuef</span><span class="w"> </span><span class="no">t1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">app</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">t2'</span><span class="o">))</span><span class="w"> </span><span class="c">(* otherwise [t1]      is a normal form *)</span><span class="w">
    </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w">    </span><span class="o">,</span><span class="w"> </span><span class="no">None</span><span class="w">    </span><span class="o">,</span><span class="w"> </span><span class="no">abs</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">t11</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">assert</span><span class="w"> </span><span class="o">(</span><span class="no">valuef</span><span class="w"> </span><span class="no">t2</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">Some</span><span class="w"> </span><span class="o">([</span><span class="no">x</span><span class="p">:</span><span class="o">=</span><span class="no">t2</span><span class="o">]</span><span class="no">t11</span><span class="o">))</span><span class="w"> </span><span class="c">(* otherwise [t1], [t2] are normal forms *)</span><span class="w">
    </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w">       </span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">       </span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">           </span><span class="o">=&gt;</span><span class="w">                     </span><span class="no">None</span><span class="w">
    </span><span class="kr">end</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">assert</span><span class="w"> </span><span class="o">(</span><span class="no">b</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">a</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">tm</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">tm</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="no">b</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">None</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>
    <p>å¯¹äºå…³ç³»ï¼Œä¸€ç›´å°±æ˜¯ implicitly applied çš„ï¼Œåœ¨å¯ç”¨æ—¶å³ä½¿ç”¨ã€‚
å¯¹äºå‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æŒ‡å®š match çš„é¡ºåº</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">stepf t1 =&gt; None</code> åªä»£è¡¨è¿™æ˜¯ä¸€ä¸ª <code class="highlighter-rouge">normal form</code>ï¼Œä½†ä¸ä¸€å®šå°±æ˜¯ <code class="highlighter-rouge">value</code>ï¼Œè¿˜æœ‰å¯èƒ½æ˜¯ stuck äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é¢å¤–çš„ <code class="highlighter-rouge">assert</code>ion. (å¤±è´¥æ—¶è¿”å›å¼‚å¸¸)
<strong>dynamics</strong> æœ¬èº«ä¸ <strong>statics</strong> æ˜¯æ­£äº¤çš„ï¼Œåœ¨ <code class="highlighter-rouge">typecheck</code> ä¹‹åæˆ‘ä»¬å¯ä»¥æœ‰ <code class="highlighter-rouge">progress</code>ï¼Œä½†æ˜¯ç°åœ¨è¿˜æ²¡æœ‰</p>
  </li>
</ol>

<h3 id="soundness">Soundness</h3>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">Theorem</span><span class="w"> </span><span class="no">sound_stepf</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">t'</span><span class="o">,</span><span class="w">
    </span><span class="no">stepf</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">t'</span><span class="w">  </span><span class="o">-&gt;</span><span class="w">  </span><span class="no">t</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="no">t'</span><span class="pi">.</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯æ˜ç”¨äº†ä¸€ä¸ª given çš„éå¸¸å¤¸å¼ çš„ automationâ€¦</p>

<p>ä¸è¿‡å¸®åŠ©æˆ‘æ‰¾åˆ°äº† <code class="highlighter-rouge">stepf</code> å’Œ <code class="highlighter-rouge">step</code> çš„å¤šå¤„ inconsistency:</p>
<ul>
  <li>3 æ¬¡åš <code class="highlighter-rouge">subst</code> æ—¶ä¾èµ–çš„ <code class="highlighter-rouge">valuef</code> ä¸èƒ½çœ</li>
  <li><code class="highlighter-rouge">valuef pair</code> è¯¥æ€ä¹ˆå†™æ‰åˆé€‚ï¼Ÿ
æœ€åæŠŠ <code class="highlighter-rouge">step</code> ä¸­çš„ <code class="highlighter-rouge">value p -&gt;</code> æ”¹æˆäº† <code class="highlighter-rouge">value v1 -&gt; value v2 -&gt;</code>ï¼Œ
å› ä¸º <code class="highlighter-rouge">valuef (pair v1 v2)</code> å‡ºæ¥çš„ <code class="highlighter-rouge">valuef v1 &amp;&amp; valuef v2</code> æ¯”è¾ƒéº»çƒ¦ã€‚
ä½†åº•çº¿æ˜¯ï¼š<strong>ä¸¤è€…å¿…é¡» consistentï¼</strong> è¿™æ—¶å°±èƒ½æ„Ÿå—åˆ° Formal Methods çš„ä¸¥è°¨äº†ã€‚</li>
</ul>

<h3 id="completeness">Completeness</h3>

<p>å‘ç°äº† pair å®ç°æ¼äº† 2 ä¸ª caseâ€¦â€¦ç„¶åæ‰å‘ç°äº† <code class="highlighter-rouge">Soundness</code> è‡ªåŠ¨åŒ–ä¸­çš„ <code class="highlighter-rouge">valuef pair</code> é—®é¢˜</p>

<h2 id="extra-mentioned">Extra (Mentioned)</h2>
<hr />

<p><a href="https://lispcast.com/church-vs-curry-types/">Church Style vs. Curry Style</a>
<a href="https://en.wikipedia.org/wiki/Rice%27s_theorem">Riceâ€™s Theorem</a></p>

<p>CakeML</p>
<ul>
  <li>prove correctness of ML lang compiler</li>
  <li>latest paper on verifying GC</li>
</ul>
:ET